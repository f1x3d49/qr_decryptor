# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

QR Decrypt App is a Flutter mobile application that scans and decrypts QR codes generated by a companion web application. This is part of a two-phase secure text sharing system using AES-256-CBC encryption.

## Development Commands

### Running the App
```bash
flutter run                    # Run on connected device/emulator
flutter run --release          # Release build
```

### Testing
```bash
flutter test                   # Run all tests
flutter test test/decryption_test.dart  # Run specific test file
```

### Dependencies
```bash
flutter pub get                # Install dependencies
flutter pub upgrade            # Upgrade dependencies
```

### Build
```bash
flutter build apk              # Build Android APK
flutter build ios              # Build iOS app
flutter clean                  # Clean build artifacts
```

### Platform-Specific
```bash
# Android
flutter build apk --release    # Release APK
flutter build appbundle        # Android App Bundle for Play Store

# iOS (requires macOS)
flutter build ios --release    # Release iOS build
```

## Architecture

### Core Components

**1. Main Entry (lib/main.dart:6)**
- App initialization with `QrDecryptApp` MaterialApp
- Home screen (`HomePage`) with "Start Scanning" CTA
- Camera permission handling via `permission_handler`

**2. QR Scanner Screen (lib/screens/qr_scanner_screen.dart)**
- Uses `qr_code_scanner` package for camera-based QR scanning
- Three states: scanning, processing, and result display
- Automatically pauses camera during decryption processing
- Error handling with retry mechanism

**3. Decryption Service (lib/services/decryption_service.dart)**
- Implements AES-256-CBC decryption using `pointycastle`
- Compatible with web app's CryptoJS encryption format
- Key methods:
  - `parseQrCode()`: Parses JSON payload from QR code (lib/services/decryption_service.dart:69)
  - `decryptText()`: Performs AES-256-CBC decryption (lib/services/decryption_service.dart:7)
  - `_removePkcs7Padding()`: Strips PKCS7 padding (lib/services/decryption_service.dart:51)

**4. Data Model (lib/models/encrypted_payload.dart)**
- `EncryptedPayload` class represents QR code payload structure
- Fields: `encryptedText`, `key`, `iv`, `version`

### Encryption/Decryption Flow

1. Web app generates QR code containing JSON: `{encryptedText, key, iv, version}`
2. Mobile app scans QR code via `QrScannerScreen`
3. `DecryptionService.parseQrCode()` parses JSON into `EncryptedPayload`
4. `DecryptionService.decryptText()` performs AES-256-CBC decryption:
   - Decodes base64 key and IV
   - Decrypts ciphertext using `pointycastle` AES-CBC
   - Removes PKCS7 padding
   - Converts to UTF-8 string
5. Decrypted text displayed in result screen

### Key Technical Details

- **Encryption Algorithm**: AES-256-CBC
- **Key Size**: 256 bits (32 bytes)
- **IV Size**: 128 bits (16 bytes)
- **Padding**: PKCS7
- **Encoding**: Base64 for encrypted data, key, and IV

### Platform Requirements

- **Android**: Minimum SDK 20 (Android 5.0), camera permission required
- **iOS**: Minimum iOS 9.0, camera usage description in Info.plist
- **Physical Device**: Required for QR scanning (emulator camera may not work reliably)

## Project Structure

```
lib/
├── main.dart                    # App entry, MaterialApp, HomePage with start button
├── models/
│   └── encrypted_payload.dart   # EncryptedPayload model: encryptedText, key, iv, version
├── services/
│   └── decryption_service.dart  # AES-256-CBC decryption using pointycastle
└── screens/
    └── qr_scanner_screen.dart   # QR scanning UI with 3 states: scan, process, result

test/
├── decryption_test.dart         # Unit tests for DecryptionService
└── widget_test.dart             # Widget tests
```

## Dependencies

**Core Packages**:
- `qr_code_scanner: ^0.7.0` - QR code scanning (older version for Flutter 2.x compatibility)
- `pointycastle: ^3.6.2` - AES encryption/decryption
- `permission_handler: ^8.3.0` - Camera permission management
- `crypto: ^3.0.2` - Cryptographic utilities
- `convert: ^3.0.2` - Base64 operations

## Common Issues

### Camera Permission Denied
- Ensure Android manifest includes camera permission
- iOS requires camera usage description in Info.plist
- Check permission status in `main.dart:127`

### Decryption Failures
- Verify QR code format matches expected JSON structure
- Ensure web app uses compatible AES-256-CBC with PKCS7 padding
- Check base64 encoding of key, IV, and ciphertext

### QR Scanner Hot Reload
- `reassemble()` method handles hot reload by pausing/resuming camera (lib/screens/qr_scanner_screen.dart:21)

## Testing Notes

- Tests located in `test/` directory
- `decryption_test.dart` focuses on JSON parsing and service methods
- Real decryption testing requires valid encrypted payloads from web app
- QR scanning requires physical device testing (not suitable for unit tests)
